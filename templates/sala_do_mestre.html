{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <!-- Área para Iniciar ou Finalizar Aventuras -->
    <div class="row">
        <div class="col-md-8">
            <h2>Sala do Mestre</h2>

            <!-- Formulário para Iniciar Aventura -->
            <form method="POST" id="start-adventure-form" action="{{ url_for('start_adventure') }}">
                <div class="mb-3">
                    <label for="adventure_id" class="form-label">Selecionar Aventura para Iniciar</label>
                    <select name="adventure_id" id="adventure_id" class="form-select" required>
                        <option value="" disabled selected>Escolha uma Aventura...</option>
                        {% for adventure in adventures %}
                        <option value="{{ adventure.id }}">{{ adventure.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Iniciar Aventura</button>
            </form>

            <!-- Botão de Finalizar Aventura -->
            <button id="finalize-adventure-btn" class="btn btn-danger mt-4">Finalizar Aventura</button>

            <!-- Formulário para Salvar Detalhes da Aventura Finalizada (escondido inicialmente) -->
            <form method="POST" id="save-final-adventure-form" action="{{ url_for('save_final_adventure') }}" class="mt-4" style="display: none;">
                <div class="mb-3">
                    <label for="title" class="form-label">Título da Aventura Finalizada</label>
                    <input type="text" name="title" id="title" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="details" class="form-label">Detalhes da Aventura Finalizada</label>
                    <textarea name="details" id="details" class="form-control" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Salvar Aventura Finalizada</button>
            </form>

            <!-- Submenu para Aventuras Finalizadas -->
            <div class="row mt-5">
                <div class="col-md-12">
                    <h3>Aventuras Finalizadas</h3>
                    {% if final_adventures %}
                    <ul class="list-group mb-3">
                        {% for adventure in final_adventures %}
                        <li class="list-group-item">
                            <strong>{{ adventure.title }}</strong>
                            <p>{{ adventure.details }}</p>
                            <small>Finalizado por: {{ adventure.finisher.user }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>Nenhuma aventura finalizada.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Área para playlists de música e efeitos sonoros -->
        <div class="col-md-4">
            <h4>Playlists</h4>

            <!-- Playlist de músicas -->
            <div class="playlist mt-3">
                <h5>Playlist de Músicas</h5>
                <ul id="music-list" class="list-group">
                    <!-- As músicas adicionadas aparecerão aqui -->
                    {% if music_playlist %}
                    {% for music in music_playlist %}
                    <li class="list-group-item">
                        {{ music.name }}
                        <audio controls>
                            <source src="{{ url_for('static', filename=music.file_path) }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
                <!-- Formulário para adicionar nova música -->
                <form method="POST" action="{{ url_for('add_music') }}" enctype="multipart/form-data" class="mt-3">
                    <input type="file" name="music_file" accept="audio/*" required>
                    <button type="submit" class="btn btn-primary btn-sm">Adicionar Música</button>
                </form>
            </div>

            <!-- Playlist de efeitos sonoros -->
            <div class="playlist mt-5">
                <h5>Playlist de Efeitos Sonoros</h5>
                <ul id="sfx-list" class="list-group">
                    <!-- Efeitos sonoros adicionados aparecerão aqui -->
                    {% if sfx_playlist %}
                    {% for sfx in sfx_playlist %}
                    <li class="list-group-item">
                        {{ sfx.name }}
                        <audio controls>
                            <source src="{{ url_for('static', filename=sfx.file_path) }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        {% if current_user.is_admin %}
                        <!-- Botão para remover efeito sonoro (visível apenas para admins) -->
                        <form method="POST" action="{{ url_for('delete_sfx', sfx_id=sfx.id) }}" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                        </form>
                        {% endif %}
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
                <!-- Formulário para adicionar novo efeito sonoro (disponível apenas para admins) -->
                {% if current_user.is_admin %}
                <form method="POST" action="{{ url_for('add_sfx') }}" enctype="multipart/form-data" class="mt-3">
                    <input type="file" name="sfx_file" accept="audio/*" required>
                    <button type="submit" class="btn btn-primary btn-sm">Adicionar Efeito Sonoro</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Área para mapas -->
    <div class="row mt-5">
        <div class="col-md-12">
            <h4>Mapas</h4>
            <select id="map-selector" class="form-select">
                <option value="" disabled selected>Escolha um mapa...</option>
                {% for map in maps %}
                <option value="{{ url_for('static', filename=map.file_path) }}">{{ map.name }}</option>
                {% endfor %}
            </select>
            <div id="map-display" class="mt-4">
                <img id="map-image" src="" alt="Mapa Selecionado" class="img-fluid" style="display: none;">
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para interatividade -->
<script>
    // Mostrar campos para finalizar aventura ao clicar no botão
    document.getElementById('finalize-adventure-btn').addEventListener('click', function () {
        document.getElementById('save-final-adventure-form').style.display = 'block';
    });

    // Trocar imagem de mapa ao selecionar
    document.getElementById('map-selector').addEventListener('change', function () {
        const mapUrl = this.value;
        const mapImage = document.getElementById('map-image');
        if (mapUrl) {
            mapImage.src = mapUrl;
            mapImage.style.display = 'block';
        } else {
            mapImage.style.display = 'none';
        }
    });
</script>
{% endblock %}
